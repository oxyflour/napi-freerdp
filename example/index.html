<html>
<body>
<style>
body { margin: 0; padding: 0 }
</style>
<script src="/socket.io/socket.io.js"></script>
<script>
const cv = document.createElement('canvas'),
    dc = cv.getContext('2d')
document.body.appendChild(cv)
cv.tabIndex = -1
cv.style.width = cv.height.height = '100%'
cv.width = window.innerWidth
cv.height = window.innerHeight
cv.focus()
cv.addEventListener('mousedown', evt => {
    const key = ['left', 'middle', 'right'][evt.button]
    ws.emit('mouse', { x: evt.clientX, y: evt.clientY, opts: { [key]: true } })
})
cv.addEventListener('mouseup', evt => {
    const key = ['left', 'middle', 'right'][evt.button]
    ws.emit('mouse', { x: evt.clientX, y: evt.clientY, opts: { [key]: false } })
})
cv.addEventListener('mousemove', evt => {
    ws.emit('mouse', { x: evt.clientX, y: evt.clientY })
})
cv.addEventListener('keydown', evt => {
    ws.emit('key', { key: evt.key + (evt.location || ''), down: true })
})
cv.addEventListener('keyup', evt => {
    ws.emit('key', { key: evt.key + (evt.location || ''), down: false })
})

const ws = io(`/?width=${cv.width}&height=${cv.height}`)
ws.on('connected', () => {
    console.log('connected')
})
ws.on('paint', ({ x, y, w, h, d }) => {
    const im = dc.createImageData(w, h),
        ar = new Uint8Array(d)
    for (let i = 0; i < w; i ++) {
        for (let j = 0; j < h; j ++) {
            const n = (j * w + i) * 4
            im.data[n    ] = ar[n + 2]
            im.data[n + 1] = ar[n + 1]
            im.data[n + 2] = ar[n    ]
            im.data[n + 3] = ar[n + 3]
        }
    }
    dc.putImageData(im, x, y)
})
ws.on('disconnect', () => {
    console.log('disconnected')
})

</script>
</body>
</html>
